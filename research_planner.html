<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ENTERPRISE SECURITY: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>Research Planner 1.4.0</title>
    <style>
        /* Default cursor for all elements */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: default;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
            background-color: #f5f5f5;
            padding: 20px;
        }
      
		@media print {
			#top-container, #download-app, #download-instructions, #app-title, #app-version, #app-buttons, .add-activity-btn, .add-activity-btn, .delete-btn, .security-warning, .security-warning.show, #securityWarning, .security-indicator, div#securityIndicator.security-indicator {
  			display: none; 
  					}
  			
  					html {
        				zoom: 65%;
    				}
    				
    				body {
			            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			            font-size: 12px;
			            padding: 0px;
			            background: white;
        			}
        			
    				.container {
			    	    max-width: 100%;
			            overflow-x: auto;
			            background: white;
			            padding: 0px;
        			}  			
		}	
		
        .container {
            max-width: 100%;
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        h2 {
            text-align: center;
            color: #444;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .console-div {
            margin-bottom: 0px;
        }  
                
        .app-download {
            clear: both;
            overflow-x: auto;
            max-width: 100%;
            display: flex;
  			justify-content: center;
  			align-items: center;
  			margin-top: 10px;
        }                  
        
        .app-download-text {
  			display: flex;
  			justify-content: center;
  			align-items: center;
			color: #999;
            font-size: 12px;
            font-style: italic;
            font-weight: normal; 
  			margin-top: 10px;
            margin-bottom: 20px;
            }

		.research-title {
  			display: flex;
  			justify-content: center;
  			align-items: center;
  			font-style: italic;
            font-weight: normal; 
  			font-size: 18px;
  			margin-bottom: 10px;
			
			}

		.wrap { 
			padding: 8px; 
			justify-content: center;
			align-items: center;
			border-radius: 4px;
            cursor: text !important;
			} 
		
		.wrap:hover { 
			padding: 7px; 
			justify-content: center;
			border: 1px dashed #686868;
			background-color: #F7FED5;
			} 
		
		.wrap:focus {	
			background-color: #F7FED5;
			border: 1px dashed #686868;
			}

        /* Security indicator styles */
        .security-indicator {
            position: relative;
            margin-top: -6px;
            width: 132px;
            background: #6BEC3E;
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 10px;
            gap: 6px;
            margin-bottom: -33px;
            text-align: center;
        }

        .security-warning {
            position: fixed;
            top: 50px;
            right: 20px;
            background: #ffc107;
            color: #333;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10001;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .security-warning.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sanitized-input {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            animation: sanitizedFlash 2s ease-out;
        }

        @keyframes sanitizedFlash {
            0% { background-color: #f8d7da; border-color: #dc3545; }
            50% { background-color: #fff3cd; border-color: #ffc107; }
            100% { background-color: transparent; border-color: transparent; }
        }

        .toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .mode-buttons {
            display: flex;
            gap: 5px;
            margin-right: 20px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer !important;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
            
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-outline {
            background: white;
            color: #6c757d;
            border: 1px solid #6c757d;
        }
        
        .btn-outline:hover {
            background: #6c757d;
            color: white;
        }
        
        .btn-outline.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .research-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
            font-size: 11px;
            margin: 0;
        }
        
        .research-table th {
            background: #BFBFBF;
            padding: 8px 6px;
            text-align: left;
            border: 1px solid #ccc;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .research-table th:nth-child(2n) {
            background: #E6E6E6;
        }
        
        .research-table td {
            padding: 6px;
            border: 1px solid #ccc;
            vertical-align: top;
            position: relative;
        }
        
        /* Activity rows - alternating colors */
        .activity-row {
            cursor: default;
        }
        
        .activity-row.activity-even {
            background-color: #f0f0f0;
        }
        
        .activity-row.activity-odd {
            background-color: #f0f0f0;
        }
        
        .activity-row:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }
        
        /* Element rows - lighter grey than activities */
        .element-row {
            cursor: default;
        }
        
        .element-row.activity-even {
            background-color: #fafafa;
        }
        
        .element-row.activity-odd {
            background-color: #fafafa;
        }
        
        .element-row:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }
        
        /* Supervisor column coloring */
        .supervisor-sent.has-data {
            background-color: #FFE990 !important;
        }
        
        .feedback-requested.has-data {
            background-color: #F9FFBC !important;
        }
        
        .supervision-committee.has-data {
            background-color: #A6FEFF !important;
        }
        
        .supervisor-sent:not(.has-data) {

        }
        
        .feedback-requested:not(.has-data) {

        }
        
        .supervision-committee:not(.has-data) {

        }
        
        .research-table tr.dragging {
            opacity: 0.5;
            background-color: #e3f2fd !important;
        }
        
        .research-table tr.drag-over {
            border-top: 3px solid #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .editable {
            min-height: 20px;
            cursor: text !important;
            padding: 2px;
            border-radius: 3px;
        }
        
        .editable:hover {
            background-color: rgba(0, 123, 255, 0.05);
            outline: 1px solid #007bff;
            cursor: text !important;
        }
        
        .editable:focus {
            outline: 2px solid #007bff;
            background-color: white;
            cursor: text !important;
        }
        
        .date-cell {
            min-width: 70px;
        }
        
        .days-cell {
            text-align: center;
            min-width: 50px;
        }
        
        .weeks-cell {
            text-align: center;
            min-width: 50px;
            color: #666;
            font-style: italic;
        }
        
        .progress-cell {
            text-align: center;
            min-width: 60px;
        }
        
        .notes-cell {
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .supervisor-sent-cell {
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .feedback-requested-cell {
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .supervision-committee-cell {
            max-width: 140px;
            word-wrap: break-word;
        }
        
        .activity-cell {
            min-width: 163px;
            font-weight: 300;
            word-wrap: break-word;
        }
        
        .chapter-cell {
            min-width: 60px;
            word-wrap: break-word;
        }
        
        .drag-handle {
            cursor: grab !important;
            padding: 4px;
            color: #666;
            font-size: 14px;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .drag-handle:hover {
            background-color: rgba(0, 123, 255, 0.1);
            border-radius: 3px;
            transform: scale(1.1);
        }
        
        .drag-handle:active {
            cursor: grabbing !important;
            transform: scale(0.95);
        }
        
        .activity-drag-handle {
            background: #007bff;
            color: white;
            border-radius: 3px;
            font-weight: bold;
            cursor: grab !important;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .activity-drag-handle:hover {
            background: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .activity-drag-handle:active {
            cursor: grabbing !important;
            transform: scale(0.95);
        }
        
        .element-drag-handle {
            background: #6c757d;
            color: white;
            border-radius: 3px;
            margin-left: 10px;
            cursor: grab !important;
            user-select: none;
            transition: all 0.2s ease;
        }
        
        .element-drag-handle:hover {
            background: #545b62;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        
        .element-drag-handle:active {
            cursor: grabbing !important;
            transform: scale(0.95);
        }
        
        .activity-name {
            font-weight: 500;
            color: #080808;
            font-size: 14px;
            line-height: 18px;
            display: block;
        }
        
        .element-prefix {
            color: #bbb;
            margin-right: 5px;
            font-weight: normal;
        }
        
        .activity-btns-prefix {
            color: #bbb;
            margin-right: 5px;
            font-weight: normal;
        }
        
        .delete-btn {
        	display: inline;
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer !important;
            font-size: 10px;
            margin-left: 5px;
            pointer-events: auto;
        }
        
        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .delete-btn:active {
            background: #a71e2a;
            transform: scale(0.95);
        }
               
        .add-element-btn {
            display: inline;
            background: #28a745;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer !important;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .add-element-btn:hover {
            background: #218838;
        }
        
        .add-activity-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }
        
        .add-activity-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }
        

        
        /* View mode styles */
        .view-mode .drag-handle,
        .view-mode .activity-drag-handle,
        .view-mode .element-drag-handle {
            display: none;
        }
        
        .view-mode .add-element-btn,
        .view-mode .delete-btn,
        .view-mode .add-activity-btn {
            display: none;
        }
        
        .view-mode .editable {
            cursor: default !important;
        }
        
        .view-mode .editable:hover {
            background-color: transparent;
            outline: none;
            cursor: default !important;
        }
        
        .view-mode .research-table th:first-child,
        .view-mode .research-table td:first-child {
            display: none;
        }
        
        /* Hide Days and Weeks columns in view mode */
        .view-mode .research-table th:nth-child(4),
        .view-mode .research-table td:nth-child(4),
        .view-mode .research-table th:nth-child(5),
        .view-mode .research-table td:nth-child(5) {
            display: none;
        }
        
        /* Hide element numbers and counts in view mode */
        .view-mode .element-prefix {
            display: none;
        }
        
        .view-mode .activity-btns-prefix {
            display: none;
        }
          
        .view-mode .element-count {
            display: none;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .modal-content {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.4;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal-btn-primary {
            background: #007bff;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #0056b3;
        }
        
        .modal-btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .modal-btn-danger:hover {
            background: #c82333;
        }
        
        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn-secondary:hover {
            background: #545b62;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 10001;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 400px;
        }
        
        .notification-error {
            background: #dc3545;
        }
        
        /* Console debug button */
        .console-btn {
            margin-top: 12px;
            float: right;
            right: 10px;
            background: #343a40;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
            cursor: pointer;
            border: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .console-btn:hover {
            opacity: 1;
        }
        
        .console-btn.active {
            background: #dc3545;
            box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
        }
        
        /* Debug Console Panel */
        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border-top: 2px solid #333;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }
        
        .debug-console.show {
            display: flex;
        }
        
        .console-header {
            background: #333;
            color: #fff;
            padding: 5px 10px;
            font-size: 10px;
            border-bottom: 1px solid #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
            line-height: 1.3;
        }
        
        .console-message {
            margin: 2px 0;
            word-wrap: break-word;
        }
        
        .console-message.debug {
            color: #00ff00;
        }
        
        .console-message.info {
            color: #00bfff;
        }
        
        .console-message.warn {
            color: #ffff00;
        }
        
        .console-message.error {
            color: #ff4444;
        }
        
        .console-message.security {
            color: #ff69b4;
            font-weight: bold;
        }
        
        .console-clear-btn {
            background: #666;
            color: white;
            border: none;
            padding: 2px 8px;
            font-size: 9px;
            cursor: pointer;
            border-radius: 2px;
        }
        
        .console-clear-btn:hover {
            background: #888;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .research-table {
                font-size: 10px;
            }
            
            .research-table th,
            .research-table td {
                padding: 4px;
            }
        }
    </style>
    <!-- ENTERPRISE SECURITY: Enhanced DOMPurify with Real-time Protection -->
    <script>
        // Enhanced DOMPurify with enterprise-grade security features
        window.DOMPurify = {
            sanitize: function(input, options = {}) {
                // Handle non-string inputs gracefully
                if (typeof input !== 'string') {
                    if (input === null || input === undefined) return '';
                    // Convert to string safely
                    return String(input);
                }
                
                // Track if content was modified for security feedback
                const originalInput = input;
                
                // Skip sanitization for safe, simple content to avoid false positives
                const isSafeContent = /^[a-zA-Z0-9\s\-_.,!?()%/:&]+$/.test(input) && 
                                     input.length < 100 && 
                                     !input.includes('<') && 
                                     !input.includes('script') && 
                                     !input.includes('javascript:');
                
                if (isSafeContent) {
                    return input;
                }
                
                // For textContent usage (which is what we primarily use), don't over-encode
                // Only encode truly dangerous content
                let sanitized = input
                    // Remove dangerous protocols and handlers
                    .replace(/javascript:/gi, '')
                    .replace(/vbscript:/gi, '')
                    .replace(/data:(?!image\/(?:png|jpe?g|gif|svg\+xml))[^;]*;/gi, '')
                    .replace(/on\w+\s*=/gi, '')
                    
                    // Remove dangerous tags completely
                    .replace(/<script[^>]*>.*?<\/script>/gi, '')
                    .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
                    .replace(/<object[^>]*>.*?<\/object>/gi, '')
                    .replace(/<embed[^>]*>/gi, '')
                    .replace(/<applet[^>]*>.*?<\/applet>/gi, '')
                    .replace(/<meta[^>]*>/gi, '')
                    .replace(/<link[^>]*>/gi, '')
                    .replace(/<style[^>]*>.*?<\/style>/gi, '')
                    .replace(/<base[^>]*>/gi, '')
                    
                    // Remove eval and other dangerous functions
                    .replace(/eval\s*\(/gi, '')
                    .replace(/setTimeout\s*\(/gi, '')
                    .replace(/setInterval\s*\(/gi, '')
                    .replace(/Function\s*\(/gi, '')
                    
                    // Remove potential encoding attacks
                    .replace(/\\x[0-9a-fA-F]{2}/g, '')
                    .replace(/\\u[0-9a-fA-F]{4}/g, '')
                    .replace(/&#x[0-9a-fA-F]+;/g, '')
                    .replace(/&#[0-9]+;/g, '')
                    
                    // Remove CSS expression attacks
                    .replace(/expression\s*\(/gi, '')
                    .replace(/-moz-binding/gi, '')
                    .replace(/behavior\s*:/gi, '');
                
                // Only encode HTML for innerHTML usage (when explicitly requested)
                if (options.forInnerHTML) {
                    sanitized = sanitized
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;')
                        .replace(/\//g, '&#x2F;');
                }
                
                // Apply length limits for DoS protection
                const maxLength = options.maxLength || 10000;
                if (sanitized.length > maxLength) {
                    sanitized = sanitized.substring(0, maxLength);
                }
                
                // Security logging for enterprise monitoring (only for actual threats)
                if (sanitized !== originalInput && !isSafeContent) {
                    window.securityEventLog = window.securityEventLog || [];
                    window.securityEventLog.push({
                        timestamp: new Date().toISOString(),
                        type: 'XSS_ATTEMPT_BLOCKED',
                        original: originalInput.substring(0, 100),
                        sanitized: sanitized.substring(0, 100),
                        source: options.source || 'unknown'
                    });
                    
                    // Trigger visual security feedback
                    if (options.element && window.showSecurityWarning) {
                        window.showSecurityWarning('Dangerous content detected and removed!', options.element);
                    }
                    
                    // Improved console logging to avoid [object Object] display
                    console.warn(`🛡️ SECURITY: Malicious content sanitized from ${options.source || 'unknown'}:`, 
                                `"${originalInput.substring(0, 50)}${originalInput.length > 50 ? '...' : ''}" → "${sanitized.substring(0, 50)}${sanitized.length > 50 ? '...' : ''}"`);
                }
                
                return sanitized;
            },
            
            // Enhanced version with HTML preservation for specific use cases
            sanitizeHTML: function(html, options = {}) {
                if (typeof html !== 'string') return '';
                
                // Allow basic formatting tags but sanitize their content
                const allowedTags = ['b', 'i', 'u', 'strong', 'em', 'br', 'p', 'div', 'span'];
                let sanitized = html;
                
                // Remove all tags except allowed ones
                sanitized = sanitized.replace(/<\/?(?!(?:b|i|u|strong|em|br|p|div|span)\b)[^>]*>/gi, '');
                
                // Sanitize content within allowed tags
                allowedTags.forEach(tag => {
                    const regex = new RegExp(`<${tag}[^>]*>(.*?)<\/${tag}>`, 'gi');
                    sanitized = sanitized.replace(regex, (match, content) => {
                        const sanitizedContent = this.sanitize(content, options);
                        return `<${tag}>${sanitizedContent}</${tag}>`;
                    });
                });
                
                return sanitized;
            }
        };
        
        // Enhanced JSON Schema Validator with security-focused validation
        window.Ajv = function() {
            return {
                compile: function(schema) {
                    return function validate(data) {
                        validate.errors = [];
                        
                        // Enhanced security validation
                        function validateRecursive(obj, schemaPath, dataPath, depth = 0) {
                            // Prevent deep nesting attacks
                            if (depth > 50) {
                                validate.errors.push({message: `Maximum nesting depth exceeded at ${dataPath}`});
                                return false;
                            }
                            
                            if (!obj || typeof obj !== 'object') return true;
                            
                            // Only flag ACTUAL prototype pollution attempts, not normal objects
                            // Check for dangerous direct property assignments to prototype chain
                            if (obj.hasOwnProperty('__proto__') && typeof obj.__proto__ === 'object') {
                                validate.errors.push({message: `Prototype pollution attempt detected at ${dataPath}`});
                                return false;
                            }
                            
                            // Check for constructor.prototype manipulation (actual attacks)
                            if (obj.hasOwnProperty('constructor') && 
                                obj.constructor && 
                                typeof obj.constructor === 'object' && 
                                obj.constructor.hasOwnProperty('prototype')) {
                                validate.errors.push({message: `Constructor prototype manipulation detected at ${dataPath}`});
                                return false;
                            }
                            
                            // Check for attempts to pollute Object.prototype specifically
                            if (obj.hasOwnProperty('prototype') && typeof obj.prototype === 'object' && 
                                (dataPath.includes('Object') || dataPath.includes('constructor'))) {
                                validate.errors.push({message: `Object prototype pollution detected at ${dataPath}`});
                                return false;
                            }
                            
                            // Array validation with security checks
                            if (Array.isArray(obj)) {
                                if (schemaPath.maxItems && obj.length > schemaPath.maxItems) {
                                    validate.errors.push({message: `Array too long at ${dataPath}`});
                                    return false;
                                }
                                
                                // Check for array bomb patterns
                                if (obj.length > 10000) {
                                    validate.errors.push({message: `Suspicious array size at ${dataPath}`});
                                    return false;
                                }
                                
                                if (schemaPath.items) {
                                    return obj.every((item, i) => validateRecursive(item, schemaPath.items, `${dataPath}[${i}]`, depth + 1));
                                }
                                return true;
                            }
                            
                            // Object property validation
                            if (schemaPath.properties) {
                                for (let key in obj) {
                                    // Check for suspicious property names
                                    if (key.includes('__') || key.includes('prototype') || key.includes('constructor')) {
                                        validate.errors.push({message: `Dangerous property name at ${dataPath}.${key}`});
                                        return false;
                                    }
                                    
                                    if (schemaPath.properties[key]) {
                                        const value = obj[key];
                                        const propSchema = schemaPath.properties[key];
                                        
                                        // Enhanced string validation
                                        if (propSchema.type === 'string' && typeof value === 'string') {
                                            if (propSchema.maxLength && value.length > propSchema.maxLength) {
                                                validate.errors.push({message: `String too long at ${dataPath}.${key}`});
                                                return false;
                                            }
                                            
                                            // Check for script injection patterns
                                            if (value.includes('<script') || value.includes('javascript:') || value.includes('data:text/html')) {
                                                validate.errors.push({message: `Script injection detected at ${dataPath}.${key}`});
                                                return false;
                                            }
                                        }
                                        
                                        // Enhanced integer validation
                                        if (propSchema.type === 'integer' || (Array.isArray(propSchema.type) && propSchema.type.includes('integer'))) {
                                            const num = parseInt(value);
                                            if (!isNaN(num)) {
                                                if (propSchema.minimum !== undefined && num < propSchema.minimum) {
                                                    validate.errors.push({message: `Number too small at ${dataPath}.${key}`});
                                                    return false;
                                                }
                                                if (propSchema.maximum !== undefined && num > propSchema.maximum) {
                                                    validate.errors.push({message: `Number too large at ${dataPath}.${key}`});
                                                    return false;
                                                }
                                            }
                                        }
                                        
                                        // Recursive validation with depth tracking
                                        if (typeof value === 'object') {
                                            if (!validateRecursive(value, propSchema, `${dataPath}.${key}`, depth + 1)) {
                                                return false;
                                            }
                                        }
                                    }
                                }
                            }
                            
                            return true;
                        }
                        
                        return validateRecursive(data, schema, 'root');
                    };
                },
                errorsText: function(errors) {
                    return errors ? errors.map(e => e.message).join(', ') : '';
                }
            };
        };
        
        console.log('🛡️ ENTERPRISE SECURITY: Enhanced security libraries loaded successfully');
    </script>
</head>
<body>
    <!-- ENTERPRISE SECURITY: Security Status Indicator -->
    <div class="security-indicator" id="securityIndicator">
        🛡️ SECURE MODE
    </div>
    
    <!-- ENTERPRISE SECURITY: Warning Display -->
    <div class="security-warning" id="securityWarning">
        <strong>Security Alert:</strong> <span id="securityMessage"></span>
    </div>

	<div>
    	<div id="top-container"> 
			<div class="console-div" id="console">
				<p>
   			 		<button class="console-btn" id="consoleBtn" title="Toggle Debug Console">📊 Console</button>
   				 </p>
   			 </div>
        </div>
        
    	<div class="app-download" id="download-app">
    		<p>
    			<button id="downloadBtn" class="btn btn-success" >Download the App</button>
    		</p>
    	</div>
    
   	 	<div class="app-download-text" id="download-instructions">    
    		<p>
use research planner app on your own computer - download the app then open .html file in a web browser
			</p>
   		</div>

    	<script>
        	document.getElementById('downloadBtn').addEventListener('click', function() {
            const element = document.createElement('a');
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            element.href = url;
            element.download = 'research-planner-1.4.0.html';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            URL.revokeObjectURL(url); // Clean up
    	    });
    	</script>

        
    <div class="container">
        <h1 id="app-title">Research Planner</h1>
        <h2 id="app-version">Version 1.4.0</h2>
            
        <div class="research-title">
        <span class="input wrap" role="textbox" contenteditable>Research Title</span>
        </div>
            
        <div class="toolbar" id="app-buttons">
            <div class="mode-buttons">
                <button class="btn btn-outline active" style="margin-right: 5px;" id="editModeBtn" onclick="setMode('edit')">✏️ Edit Mode</button>
                <button class="btn btn-outline" id="viewModeBtn" onclick="setMode('view')">👁️ View Mode</button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-right: 0px;">
                <label for="researchStartDate" style="font-weight: bold; color: #333;">📅 Research Start Date:</label>
                <input type="date" id="researchStartDate" value="2025-03-01" style="margin-right: 20px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
            </div>
            
            <button style="margin-left: 5px;" class="btn btn-success" data-action="save-data">💾 Save Data</button>
            <button class="btn btn-primary" data-action="load-data">📁 Load Data</button>
            <button class="btn btn-secondary" data-action="delete-all" >🗑️ Delete All</button>
            
            <span style="margin-left: 10px; color: #666; font-size: 11px;" id="modeHelp">
                <strong>Edit Mode:</strong>
                Drag Activities/Elements to reorder • Click cells to edit • Use + buttons to add elements
            </span>
        </div>
        
        <table class="research-table" id="researchTable">
            <thead>
                <tr>
                    <th id="drag-col" style="width: 50px;">Drag</th>
                    <th>Activity / Element</th>
                    <th>Research / Chapter</th>
                    <th id="days-col">Days</th>
                    <th id="weeks-col">Weeks</th>
                    <th>Notes</th>
                    <th>Progress</th>
                    <th>Start Date</th>
                    <th>Expected Completion</th>
                    <th style="background: #A6FEFF;">Supervision / Meeting</th>
                    <th style="background: #FFE990;">Docs Sent</th>
                    <th style="background: #F9FFBC;">Feedback Requested</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
    
    <button class="add-activity-btn" title="Add New Activity">+</button>

    <!-- Debug Console Panel -->
    <div class="debug-console" id="debugConsole">
        <div class="console-header">
            <span>🔧 Debug Console - Research Planner Enterprise Security v1.4.0</span>
            <button class="console-clear-btn" id="consoleClearBtn">Clear</button>
        </div>
        <div class="console-content" id="consoleContent">
            <div class="console-message info">🛡️ Enterprise Security Console Ready - Enhanced monitoring active...</div>
        </div>
    </div>

    <script>
        // ================================
        // ENTERPRISE SECURITY FUNCTIONS
        // ================================

        // Enhanced security warning system
        function showSecurityWarning(message, element = null) {
            const warning = document.getElementById('securityWarning');
            const messageSpan = document.getElementById('securityMessage');
            
            if (warning && messageSpan) {
                messageSpan.textContent = message;
                warning.classList.add('show');
                
                // Highlight the problematic element
                if (element) {
                    element.classList.add('sanitized-input');
                    setTimeout(() => {
                        element.classList.remove('sanitized-input');
                    }, 3000);
                }
                
                // Auto-hide warning after 5 seconds
                setTimeout(() => {
                    warning.classList.remove('show');
                }, 5000);
                
                // Log security event to console
                addConsoleMessage(`Security Warning: ${message}`, 'security');
            }
        }

        // Enhanced sanitization with visual feedback
        function secureSanitizeInput(input, element = null, source = 'unknown') {
            // Handle non-string inputs gracefully
            if (typeof input !== 'string') {
                if (input === null || input === undefined) return '';
                input = String(input);
            }
            
            const originalInput = input;
            const sanitized = DOMPurify.sanitize(input, {
                element: element,
                source: source,
                maxLength: 10000
            });
            
            // Only show warning if content was actually changed and it's a real threat
            if (sanitized !== originalInput && 
                (originalInput.includes('<') || originalInput.includes('script') || originalInput.includes('javascript:'))) {
                showSecurityWarning('Dangerous content detected and removed!', element);
            }
            
            return sanitized;
        }

        // Enhanced file content security scanner
        function securityScanFileContent(content, filename) {
            const suspiciousPatterns = [
                /<script[^>]*>/gi,
                /javascript:/gi,
                /vbscript:/gi,
                /on\w+\s*=/gi,
                /eval\s*\(/gi,
                /Function\s*\(/gi,
                /setTimeout\s*\(/gi,
                /setInterval\s*\(/gi,
                /__proto__/gi,
                /constructor\.prototype/gi,
                /data:text\/html/gi,
                /data:text\/javascript/gi
            ];
            
            const threats = [];
            
            suspiciousPatterns.forEach((pattern, index) => {
                const matches = content.match(pattern);
                if (matches) {
                    threats.push({
                        pattern: pattern.toString(),
                        count: matches.length,
                        severity: index < 6 ? 'HIGH' : 'MEDIUM'
                    });
                }
            });
            
            if (threats.length > 0) {
                addConsoleMessage(`🚨 SECURITY SCAN: ${threats.length} threats detected in ${filename}`, 'security');
                threats.forEach(threat => {
                    addConsoleMessage(`  - ${threat.pattern}: ${threat.count} matches (${threat.severity})`, 'security');
                });
                
                throw new Error(`Security scan failed: ${threats.length} suspicious patterns detected in uploaded file. File rejected for safety.`);
            }
            
            addConsoleMessage(`✅ SECURITY SCAN: File ${filename} passed security validation`, 'security');
            return true;
        }

        // ================================
        // CUSTOM MODAL FUNCTIONS (Browser-block resistant)
        // ================================

        function showCustomConfirm(title, message, onConfirm, onCancel) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.textContent = title;
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.textContent = message;
            
            const buttons = document.createElement('div');
            buttons.className = 'modal-buttons';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => {
                document.body.removeChild(overlay);
                if (onCancel) onCancel();
            };
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-danger';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                document.body.removeChild(overlay);
                if (onConfirm) onConfirm();
            };
            
            buttons.appendChild(cancelBtn);
            buttons.appendChild(confirmBtn);
            
            modal.appendChild(header);
            modal.appendChild(content);
            modal.appendChild(buttons);
            overlay.appendChild(modal);
            
            document.body.appendChild(overlay);
            
            // Focus the confirm button
            confirmBtn.focus();
        }

        function showCustomAlert(title, message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'notification-error' : ''}`;
            
            const header = document.createElement('strong');
            header.textContent = title;
            
            const content = document.createElement('div');
            content.innerHTML = message.replace(/\n/g, '<br>');
            
            notification.appendChild(header);
            notification.appendChild(document.createElement('br'));
            notification.appendChild(content);
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 5000);
            
            // Click to dismiss
            notification.onclick = () => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            };
        }

        function showSaveSuccessModal(filename, totalActivities, totalElements) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.maxWidth = '600px';
            
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.textContent = '✅ Research Plan Copied to Clipboard!';
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.innerHTML = `
                <p><strong>🛡️ Security:</strong> Data exported safely with enterprise-grade protection</p>
                <p><strong>📋 Next steps:</strong></p>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Open any text editor (Notepad, TextEdit, VS Code, etc.)</li>
                    <li>Paste with <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac)</li>
                    <li>Save as: <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 2px;">${filename}</code></li>
                </ol>
                <p><strong>📊 Exported:</strong> ${totalActivities} activities, ${totalElements} elements</p>
                <p><strong>📅 Export time:</strong> ${new Date().toLocaleString()}</p>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    💡 <strong>Tip:</strong> Use a plain text editor (like Notepad) to avoid formatting issues
                </p>
            `;
            
            const buttons = document.createElement('div');
            buttons.className = 'modal-buttons';
            
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn modal-btn-primary';
            okBtn.textContent = 'Got it!';
            okBtn.onclick = () => {
                document.body.removeChild(overlay);
            };
            
            buttons.appendChild(okBtn);
            
            modal.appendChild(header);
            modal.appendChild(content);
            modal.appendChild(buttons);
            overlay.appendChild(modal);
            
            document.body.appendChild(overlay);
            
            // Focus the OK button
            okBtn.focus();
        }

        function showCustomPrompt(title, message, defaultValue, onSubmit) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            const header = document.createElement('div');
            header.className = 'modal-header';
            header.textContent = title;
            
            const content = document.createElement('div');
            content.className = 'modal-content';
            content.textContent = message;
            
            const textarea = document.createElement('textarea');
            textarea.style.width = '100%';
            textarea.style.height = '200px';
            textarea.style.marginTop = '10px';
            textarea.value = defaultValue;
            textarea.readOnly = true;
            textarea.style.fontFamily = 'monospace';
            textarea.style.fontSize = '12px';
            
            const buttons = document.createElement('div');
            buttons.className = 'modal-buttons';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'modal-btn modal-btn-primary';
            copyBtn.textContent = 'Copy to Clipboard';
            copyBtn.onclick = () => {
                textarea.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy to Clipboard', 2000);
            };
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'modal-btn modal-btn-secondary';
            closeBtn.textContent = 'Close';
            closeBtn.onclick = () => {
                document.body.removeChild(overlay);
            };
            
            buttons.appendChild(copyBtn);
            buttons.appendChild(closeBtn);
            
            modal.appendChild(header);
            modal.appendChild(content);
            modal.appendChild(textarea);
            modal.appendChild(buttons);
            overlay.appendChild(modal);
            
            document.body.appendChild(overlay);
            
            // Auto-select text
            textarea.select();
        }

        // ================================
        // ENHANCED SECURITY CONFIGURATION
        // ================================
        
        const SECURITY_CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            MAX_JSON_DEPTH: 10,
            MAX_STRING_LENGTH: 10000,
            ALLOWED_FILE_TYPES: ['.json', 'application/json', 'text/plain'],
            PARSING_TIMEOUT: 5000, // 5 seconds
            MAX_ACTIVITIES: 1000,
            MAX_ELEMENTS_PER_ACTIVITY: 100,
            SECURITY_SCAN_ENABLED: true,
            REAL_TIME_PROTECTION: true
        };

        // Enhanced JSON Schema for validation with security focus
        const DATA_SCHEMA = {
            type: "object",
            properties: {
                version: { type: "string", maxLength: 10 },
                appName: { type: "string", maxLength: 50 },
                exportDate: { type: "string", format: "date-time" },
                researchStartDate: { type: "string", pattern: "^\\d{4}-\\d{2}-\\d{2}$" },
                totalActivities: { type: "integer", minimum: 0, maximum: SECURITY_CONFIG.MAX_ACTIVITIES },
                totalElements: { type: "integer", minimum: 0 },
                data: {
                    type: "array",
                    maxItems: SECURITY_CONFIG.MAX_ACTIVITIES,
                    items: {
                        type: "object",
                        required: ["activityName", "elements"],
                        properties: {
                            activityName: { type: "string", maxLength: 200 },
                            elements: {
                                type: "array",
                                maxItems: SECURITY_CONFIG.MAX_ELEMENTS_PER_ACTIVITY,
                                items: {
                                    type: "object",
                                    properties: {
                                        chapter: { type: "string", maxLength: 200 },
                                        days: { type: ["integer", "string"], minimum: 0, maximum: 3650 },
                                        notes: { type: "string", maxLength: SECURITY_CONFIG.MAX_STRING_LENGTH },
                                        progress: { type: "string", maxLength: 50 },
                                        startDate: { type: "string", pattern: "^(\\d{4}-\\d{2}-\\d{2}|-)$" },
                                        expectedDate: { type: "string", pattern: "^(\\d{4}-\\d{2}-\\d{2}|-)$" },
                                        supervisionCommittee: { type: "string", maxLength: SECURITY_CONFIG.MAX_STRING_LENGTH },
                                        supervisorSent: { type: "string", maxLength: SECURITY_CONFIG.MAX_STRING_LENGTH },
                                        feedbackRequested: { type: "string", maxLength: SECURITY_CONFIG.MAX_STRING_LENGTH }
                                    },
                                    additionalProperties: false
                                }
                            }
                        },
                        additionalProperties: false
                    }
                }
            },
            required: ["data"],
            additionalProperties: false
        };

        // ================================
        // ENHANCED SECURITY FUNCTIONS
        // ================================

        function sanitizeString(str, maxLength = SECURITY_CONFIG.MAX_STRING_LENGTH) {
            // Handle non-string inputs gracefully without false security warnings
            if (typeof str !== 'string') {
                if (str === null || str === undefined) return '';
                return String(str).substring(0, maxLength);
            }
            
            // For simple, safe strings, skip complex sanitization to avoid false positives
            // Include "&" as a safe character for normal text content
            if (str.length < 100 && /^[a-zA-Z0-9\s\-_.,!?()%/:&]+$/.test(str)) {
                return str.substring(0, maxLength);
            }
            
            return secureSanitizeInput(str, null, 'string_sanitization').substring(0, maxLength);
        }

        function sanitizeForStorage(str, maxLength = SECURITY_CONFIG.MAX_STRING_LENGTH) {
            // Handle non-string inputs gracefully
            if (typeof str !== 'string') {
                if (str === null || str === undefined) return '';
                return String(str).substring(0, maxLength);
            }
            
            return secureSanitizeInput(str, null, 'file_import').substring(0, maxLength);
        }

        function createSecureElement(tagName, textContent = '', className = '') {
            const element = document.createElement(tagName);
            if (className) {
                element.className = className;
            }
            if (textContent) {
                // Use textContent for automatic HTML encoding
                element.textContent = sanitizeString(textContent);
            }
            return element;
        }

        function validateFileSize(file) {
            if (file.size > SECURITY_CONFIG.MAX_FILE_SIZE) {
                throw new Error(`File too large. Maximum size: ${SECURITY_CONFIG.MAX_FILE_SIZE / 1024 / 1024}MB`);
            }
        }

        function validateFileType(file) {
            const fileName = file.name.toLowerCase();
            const isValidType = SECURITY_CONFIG.ALLOWED_FILE_TYPES.some(type => 
                fileName.endsWith(type) || file.type === type
            );
            
            if (!isValidType) {
                throw new Error('Invalid file type. Only JSON files are allowed.');
            }
        }

        function validateJsonStructure(data) {
            // Check for JSON bomb patterns
            const jsonString = JSON.stringify(data);
            if (jsonString.length > SECURITY_CONFIG.MAX_FILE_SIZE) {
                throw new Error('Data structure too large');
            }

            // Initialize AJV validator
            if (window.Ajv) {
                const ajv = new Ajv({ strict: false, validateFormats: false });
                const validate = ajv.compile(DATA_SCHEMA);
                
                if (!validate(data)) {
                    console.error('Schema validation errors:', validate.errors);
                    addConsoleMessage('Schema validation failed: ' + ajv.errorsText(validate.errors), 'security');
                    throw new Error('Invalid data format: ' + ajv.errorsText(validate.errors));
                }
            } else {
                console.warn('AJV not available, using basic validation');
                // Fallback validation
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid data format');
                }
            }

            return true;
        }

        function sanitizeLoadedData(data) {
            if (Array.isArray(data)) {
                // Handle old format (direct array)
                return data.map(sanitizeActivity);
            } else if (data && data.data && Array.isArray(data.data)) {
                // Handle new format (object with data property)
                const sanitizedObject = {
                    version: sanitizeString(data.version || '1.0', 10),
                    appName: sanitizeString(data.appName || 'Research Planner', 50),
                    exportDate: data.exportDate || new Date().toISOString(),
                    researchStartDate: sanitizeString(data.researchStartDate || '2025-03-01', 12),
                    totalActivities: Math.max(0, Math.min(parseInt(data.totalActivities) || 0, SECURITY_CONFIG.MAX_ACTIVITIES)),
                    totalElements: Math.max(0, parseInt(data.totalElements) || 0),
                    data: data.data.map(sanitizeActivity)
                };
                return sanitizedObject;
            }
            
            throw new Error('Unrecognized data format');
        }

        function sanitizeActivity(activity) {
            if (!activity || typeof activity !== 'object') {
                throw new Error('Invalid activity data');
            }

            return {
                activityName: sanitizeForStorage(activity.activityName || 'New Activity', 200),
                elements: (activity.elements || []).slice(0, SECURITY_CONFIG.MAX_ELEMENTS_PER_ACTIVITY).map(sanitizeElement)
            };
        }

        function sanitizeElement(element) {
            if (!element || typeof element !== 'object') {
                return createDefaultElement();
            }

            return {
                chapter: sanitizeForStorage(element.chapter || '', 200),
                days: Math.max(0, Math.min(parseInt(element.days) || 0, 3650)),
                notes: sanitizeForStorage(element.notes || '', SECURITY_CONFIG.MAX_STRING_LENGTH),
                progress: sanitizeForStorage(element.progress || '', 50),
                startDate: validateDateString(element.startDate) ? element.startDate : '',
                expectedDate: validateDateString(element.expectedDate) ? element.expectedDate : '',
                supervisionCommittee: sanitizeForStorage(element.supervisionCommittee || '', SECURITY_CONFIG.MAX_STRING_LENGTH),
                supervisorSent: sanitizeForStorage(element.supervisorSent || '', SECURITY_CONFIG.MAX_STRING_LENGTH),
                feedbackRequested: sanitizeForStorage(element.feedbackRequested || '', SECURITY_CONFIG.MAX_STRING_LENGTH)
            };
        }

        function validateDateString(dateStr) {
            if (!dateStr || dateStr === '-') return true;
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            return dateRegex.test(dateStr);
        }

        function createDefaultElement() {
            return {
                chapter: '',
                days: 7,
                notes: '',
                progress: '0%',
                startDate: '',
                expectedDate: '',
                supervisionCommittee: '',
                supervisorSent: '',
                feedbackRequested: ''
            };
        }

        // ================================
        // DEBUG MODE FUNCTIONALITY
        // ================================
        
        let debugMode = false;
        
        function addConsoleMessage(message, type = 'debug') {
            if (!debugMode) return;
            
            const consoleContent = document.getElementById('consoleContent');
            if (!consoleContent) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `console-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'debug' ? '🔧 DEBUG' : 
                          type === 'info' ? 'ℹ️ INFO' : 
                          type === 'warn' ? '⚠️ WARN' : 
                          type === 'error' ? '❌ ERROR' : 
                          type === 'security' ? '🛡️ SECURITY' : '🔧 DEBUG';
            
            messageDiv.textContent = `[${timestamp}] ${prefix}: ${message}`;
            
            consoleContent.appendChild(messageDiv);
            
            // Auto-scroll to bottom
            consoleContent.scrollTop = consoleContent.scrollHeight;
            
            // Limit console to 100 messages to prevent memory issues
            const messages = consoleContent.children;
            if (messages.length > 100) {
                consoleContent.removeChild(messages[1]); // Keep the welcome message
            }
        }
        
        function debugLog(...args) {
            if (debugMode) {
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                // Only send to visual console (not browser console to avoid duplication)
                addConsoleMessage(message, 'debug');
            }
        }
        
        function clearConsole() {
            const consoleContent = document.getElementById('consoleContent');
            if (consoleContent) {
                consoleContent.innerHTML = '<div class="console-message info">🛡️ Enterprise Security Console Ready - Enhanced monitoring active...</div>';
            }
        }
        
        function toggleDebugMode() {
            debugMode = !debugMode;
            const consoleBtn = document.getElementById('consoleBtn');
            const debugConsole = document.getElementById('debugConsole');
            
            if (debugMode) {
                consoleBtn.classList.add('active');
                consoleBtn.textContent = '🔴 Console ON';
                consoleBtn.title = 'Debug Console is ON - Click to disable';
                debugConsole.classList.add('show');
                
                console.log('🔧 DEBUG MODE ENABLED - Console panel is now visible');
                addConsoleMessage('Debug mode activated - Enhanced security monitoring enabled', 'info');
                addConsoleMessage('Enterprise-grade protection active', 'security');
                debugLog('Debug mode activated');
            } else {
                consoleBtn.classList.remove('active');
                consoleBtn.textContent = '📊 Console';
                consoleBtn.title = 'Toggle Debug Console';
                debugConsole.classList.remove('show');
                
                console.log('🔧 DEBUG MODE DISABLED - Console panel hidden');
            }
        }

        // ================================
        // GLOBAL VARIABLES & DATA
        // ================================
        
        let currentMode = 'edit';
        let draggedElement = null;
        let researchStartDate = '2025-03-01'; // Default research start date
        
        let researchData = [
    {
      "activityName": "# First Supervision Meeting",
      "elements": [
        {
          "chapter": "Preparation",
          "days": 20,
          "notes": "Prepare for first supervision",
          "progress": "",
          "startDate": "2025-03-01",
          "expectedDate": "2025-03-21",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Draft docs",
          "days": 7,
          "notes": "Draft docs and send updates to supervisors",
          "progress": "",
          "startDate": "2025-03-21",
          "expectedDate": "2025-03-28",
          "supervisionCommittee": "",
          "supervisorSent": "Research plan sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Primary Supervisor's Office",
          "progress": "",
          "startDate": "2025-03-28",
          "expectedDate": "2025-03-29",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Reading & Writing",
      "elements": [
        {
          "chapter": "",
          "days": 20,
          "notes": "Reading and writing",
          "progress": "",
          "startDate": "2025-03-30",
          "expectedDate": "2025-04-19",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Supervisory Agreement",
      "elements": [
        {
          "chapter": "Supervisory Agreement",
          "days": 7,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-04-20",
          "expectedDate": "2025-04-27",
          "supervisionCommittee": "",
          "supervisorSent": "Draft Agreement sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom & Sign/Finalise Agreement",
          "progress": "",
          "startDate": "2025-04-27",
          "expectedDate": "2025-04-28",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Sign agreement by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Research Methodology Course",
      "elements": [
        {
          "chapter": "Research Methodology",
          "days": 28,
          "notes": "Course",
          "progress": "",
          "startDate": "2025-04-29",
          "expectedDate": "2025-05-27",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2025-05-27",
          "expectedDate": "2025-05-28",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Research Methodology",
          "days": 28,
          "notes": "Course",
          "progress": "0%",
          "startDate": "2025-05-28",
          "expectedDate": "2025-06-25",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Topic",
      "elements": [
        {
          "chapter": "Topic",
          "days": 13,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-06-26",
          "expectedDate": "2025-07-09",
          "supervisionCommittee": "",
          "supervisorSent": "Topic sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2025-07-09",
          "expectedDate": "2025-07-10",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Winter Break",
      "elements": [
        {
          "chapter": "",
          "days": 14,
          "notes": "Break",
          "progress": "0%",
          "startDate": "2025-07-11",
          "expectedDate": "2025-07-25",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Reading & Writing",
      "elements": [
        {
          "chapter": "",
          "days": 28,
          "notes": "Reading and writing",
          "progress": "",
          "startDate": "2025-07-26",
          "expectedDate": "2025-08-23",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Research Question",
      "elements": [
        {
          "chapter": "Research Question",
          "days": 14,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-08-24",
          "expectedDate": "2025-09-07",
          "supervisionCommittee": "",
          "supervisorSent": "Research Question sent: 00 Mon 20XX",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting:",
          "progress": "",
          "startDate": "2025-09-07",
          "expectedDate": "2025-09-08",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Reading & Writing",
      "elements": [
        {
          "chapter": "",
          "days": 28,
          "notes": "Reading & writing",
          "progress": "",
          "startDate": "2025-09-09",
          "expectedDate": "2025-10-06",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Annotated Bibliography",
      "elements": [
        {
          "chapter": "Annotated Bibliography",
          "days": 21,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-10-07",
          "expectedDate": "2025-10-28",
          "supervisionCommittee": "",
          "supervisorSent": "Annotated Bibliography sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2025-10-28",
          "expectedDate": "2025-10-29",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Methodology Outline",
      "elements": [
        {
          "chapter": "Methodology Outline",
          "days": 28,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-10-30",
          "expectedDate": "2025-11-27",
          "supervisionCommittee": "",
          "supervisorSent": "Methodology Outline sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2025-11-27",
          "expectedDate": "2025-11-28",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Reading & Writing",
      "elements": [
        {
          "chapter": "",
          "days": 22,
          "notes": "Reading and writing",
          "progress": "",
          "startDate": "2025-11-29",
          "expectedDate": "2025-12-21",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Literature Review Chapter",
      "elements": [
        {
          "chapter": "Literature Review",
          "days": 38,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2025-12-22",
          "expectedDate": "2026-01-29",
          "supervisionCommittee": "",
          "supervisorSent": "Lit Review Chapter sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Re-draft and send to supervisors",
          "progress": "",
          "startDate": "2026-01-29",
          "expectedDate": "2026-01-30",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Literature Review",
          "days": 5,
          "notes": "Edit (incorporate feedback) and send to proofer",
          "progress": "0%",
          "startDate": "2026-01-30",
          "expectedDate": "2026-02-04",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Summer Break",
      "elements": [
        {
          "chapter": "Xmas and New Year's",
          "days": 14,
          "notes": "Break",
          "progress": "",
          "startDate": "2026-02-05",
          "expectedDate": "2026-02-19",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "#CONFIRMATION",
      "elements": [
        {
          "chapter": "Preparation",
          "days": 20,
          "notes": "Draft confirmation docs and form",
          "progress": "0%",
          "startDate": "2026-02-20",
          "expectedDate": "2026-03-12",
          "supervisionCommittee": "",
          "supervisorSent": "Draft confirmation report sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-03-12",
          "expectedDate": "2026-03-13",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Confirmation",
          "days": 13,
          "notes": "Committee Meeting: Confirmation",
          "progress": "0%",
          "startDate": "2026-03-13",
          "expectedDate": "2026-03-26",
          "supervisionCommittee": "CONFIRMATION: 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Draft Ethics Application",
      "elements": [
        {
          "chapter": "Ethics application",
          "days": 13,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2026-03-27",
          "expectedDate": "2026-04-09",
          "supervisionCommittee": "",
          "supervisorSent": "Draft Ethics application sent: 00 Mon 20XX",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-04-09",
          "expectedDate": "2026-04-10",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Final Ethics Application",
      "elements": [
        {
          "chapter": "Ethics Application - final draft",
          "days": 12,
          "notes": "Write final draft",
          "progress": "0%",
          "startDate": "2026-04-11",
          "expectedDate": "2026-04-23",
          "supervisionCommittee": "",
          "supervisorSent": "Final Application sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-04-23",
          "expectedDate": "2026-04-24",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Creative Output 1 - Part 1",
      "elements": [
        {
          "chapter": "Making",
          "days": 36,
          "notes": "Making creative output",
          "progress": "0%",
          "startDate": "2026-04-25",
          "expectedDate": "2026-05-31",
          "supervisionCommittee": "",
          "supervisorSent": "Creative notes sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-05-31",
          "expectedDate": "2026-06-01",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Winter Break",
      "elements": [
        {
          "chapter": "",
          "days": 14,
          "notes": "Break",
          "progress": "",
          "startDate": "2026-06-02",
          "expectedDate": "2026-06-16",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Creative Output 1 - Part 2",
      "elements": [
        {
          "chapter": "Making",
          "days": 28,
          "notes": "Making creative output",
          "progress": "0%",
          "startDate": "2026-06-17",
          "expectedDate": "2026-07-15",
          "supervisionCommittee": "",
          "supervisorSent": "Creative notes sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-07-15",
          "expectedDate": "2026-07-16",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Making",
          "days": 40,
          "notes": "Making creative output",
          "progress": "0%",
          "startDate": "2026-07-16",
          "expectedDate": "2026-08-25",
          "supervisionCommittee": "",
          "supervisorSent": "Creative notes sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-08-25",
          "expectedDate": "2026-08-26",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Making",
          "days": 28,
          "notes": "Making creative output",
          "progress": "0%",
          "startDate": "2026-08-26",
          "expectedDate": "2026-09-23",
          "supervisionCommittee": "",
          "supervisorSent": "Creative output sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-09-23",
          "expectedDate": "2026-09-24",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Finalising",
          "days": 21,
          "notes": "Finalising creative output",
          "progress": "0%",
          "startDate": "2026-09-24",
          "expectedDate": "2026-10-14",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Reading & Writing",
      "elements": [
        {
          "chapter": "",
          "days": 21,
          "notes": "Reading and writing",
          "progress": "",
          "startDate": "2026-10-15",
          "expectedDate": "2026-11-05",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Interviews with Practitioners",
      "elements": [
        {
          "chapter": "Interviewing",
          "days": 26,
          "notes": "Conduct interviews",
          "progress": "0%",
          "startDate": "2026-11-06",
          "expectedDate": "2026-12-02",
          "supervisionCommittee": "",
          "supervisorSent": "Update on interviews sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2026-12-02",
          "expectedDate": "2026-12-03",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Interviewing",
          "days": 21,
          "notes": "Conduct interviews",
          "progress": "0%",
          "startDate": "2026-12-03",
          "expectedDate": "2026-12-24",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Summer Break",
      "elements": [
        {
          "chapter": "Xmas and New Year's",
          "days": 16,
          "notes": "Break",
          "progress": "",
          "startDate": "2026-12-25",
          "expectedDate": "2027-01-10",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Data Analysis",
      "elements": [
        {
          "chapter": "Interviews",
          "days": 28,
          "notes": "Coding themes and memos",
          "progress": "0%",
          "startDate": "2027-01-11",
          "expectedDate": "2027-02-08",
          "supervisionCommittee": "",
          "supervisorSent": "Notes on data sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-02-08",
          "expectedDate": "2027-02-09",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Interviews",
          "days": 21,
          "notes": "Completed themes and memos with charts",
          "progress": "0%",
          "startDate": "2027-02-09",
          "expectedDate": "2027-03-02",
          "supervisionCommittee": "",
          "supervisorSent": "Notes on data sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-03-02",
          "expectedDate": "2027-03-03",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Finalise data analysis",
          "days": 7,
          "notes": "Completed themes and memos with charts",
          "progress": "0%",
          "startDate": "2027-03-03",
          "expectedDate": "2027-03-10",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "# PROGRESS REVIEW YEAR 2",
      "elements": [
        {
          "chapter": "Progress Review Form",
          "days": 14,
          "notes": "Draft Progress Review Form & docs",
          "progress": "0%",
          "startDate": "2027-03-11",
          "expectedDate": "2027-03-25",
          "supervisionCommittee": "",
          "supervisorSent": "Draft Review Form sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-03-25",
          "expectedDate": "2027-03-26",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Progress Review",
          "days": 7,
          "notes": "Committee Meeting: Progress Review",
          "progress": "0%",
          "startDate": "2027-03-26",
          "expectedDate": "2027-04-02",
          "supervisionCommittee": "PROGRESS REVIEW: 00 Mon 20XX",
          "supervisorSent": "Final Review Form sent: 00 Mon 20XX",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Methodology Chapter",
      "elements": [
        {
          "chapter": "Methodology",
          "days": 27,
          "notes": "Write first draft",
          "progress": "0%",
          "startDate": "2027-04-03",
          "expectedDate": "2027-04-30",
          "supervisionCommittee": "",
          "supervisorSent": "Methodology Chapter sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Creative Output 2 Planning",
          "days": 16,
          "notes": "Plan creative output while waiting for feedback",
          "progress": "",
          "startDate": "2027-04-30",
          "expectedDate": "2027-05-16",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-05-16",
          "expectedDate": "2027-05-17",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Methodology",
          "days": 14,
          "notes": "Edit (incorporate feedback) and send to proofer",
          "progress": "",
          "startDate": "2027-05-17",
          "expectedDate": "2027-05-31",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Ethics Revision",
      "elements": [
        {
          "chapter": "Ethics Revision",
          "days": 7,
          "notes": "Write first draft revision",
          "progress": "",
          "startDate": "2027-06-01",
          "expectedDate": "2027-06-08",
          "supervisionCommittee": "",
          "supervisorSent": "Ethics Revision sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Creative Planning",
          "days": 28,
          "notes": "Start creative planning on creative output #2",
          "progress": "",
          "startDate": "2027-06-08",
          "expectedDate": "2027-07-06",
          "supervisionCommittee": "",
          "supervisorSent": "Creative notes sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-07-06",
          "expectedDate": "2027-07-07",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Ethics Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Submit ethics revision",
          "days": 7,
          "notes": "Finalise and submit Ethics Revision",
          "progress": "0%",
          "startDate": "2027-07-07",
          "expectedDate": "2027-07-14",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Creative Output Planning",
      "elements": [
        {
          "chapter": "Creative Plan",
          "days": 21,
          "notes": "Draft plan for creative output #2",
          "progress": "0%",
          "startDate": "2027-07-15",
          "expectedDate": "2027-08-05",
          "supervisionCommittee": "",
          "supervisorSent": "Creative plan sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Submit Ethics Revision",
          "days": 6,
          "notes": "Submit Ethics Revision while waiting for creative feedback",
          "progress": "",
          "startDate": "2027-08-05",
          "expectedDate": "2027-08-11",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-08-11",
          "expectedDate": "2027-08-12",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Creative Plan Feedback Requested by: 00 Mon 20XX"
        }
      ]
    },
    {
      "activityName": "Creative Output 2",
      "elements": [
        {
          "chapter": "Creative Planning",
          "days": 14,
          "notes": "Creative planning",
          "progress": "",
          "startDate": "2027-08-13",
          "expectedDate": "2027-08-27",
          "supervisionCommittee": "",
          "supervisorSent": "Creative plan sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-08-27",
          "expectedDate": "2027-08-28",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Creative Output",
          "days": 36,
          "notes": "Creative research",
          "progress": "",
          "startDate": "2027-08-28",
          "expectedDate": "2027-10-02",
          "supervisionCommittee": "",
          "supervisorSent": "Creative output sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Completion Preparation",
          "days": 23,
          "notes": "Write first draft presentation",
          "progress": "0%",
          "startDate": "2027-10-02",
          "expectedDate": "2027-10-24",
          "supervisionCommittee": "",
          "supervisorSent": "Completion presentation sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-10-24",
          "expectedDate": "2027-10-25",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Creative Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Creative Output",
          "days": 36,
          "notes": "Finalise creative output",
          "progress": "0%",
          "startDate": "2027-10-25",
          "expectedDate": "2027-11-30",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Summer Break",
      "elements": [
        {
          "chapter": "Xmas and New Year's",
          "days": 14,
          "notes": "Break",
          "progress": "",
          "startDate": "2027-12-01",
          "expectedDate": "2027-12-15",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "# COMPLETION SEMINAR",
      "elements": [
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2027-12-16",
          "expectedDate": "2027-12-17",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Completion Presentation Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Finalise presentation",
          "days": 16,
          "notes": "Finalise completion presentation",
          "progress": "0%",
          "startDate": "2027-12-17",
          "expectedDate": "2028-01-02",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Completion Seminar",
          "days": 1,
          "notes": "Present research",
          "progress": "0%",
          "startDate": "2028-01-02",
          "expectedDate": "2028-01-03",
          "supervisionCommittee": "Seminar: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "Editing and Proofing",
      "elements": [
        {
          "chapter": "Edit dissertation",
          "days": 28,
          "notes": "Editing",
          "progress": "0%",
          "startDate": "2028-01-04",
          "expectedDate": "2028-02-01",
          "supervisionCommittee": "",
          "supervisorSent": "Edited thesis sent: 00 Mon 20XX",
          "feedbackRequested": ""
        },
        {
          "chapter": "Proof dissertation",
          "days": 21,
          "notes": "Proofing",
          "progress": "0%",
          "startDate": "2028-02-01",
          "expectedDate": "2028-02-22",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2028-02-22",
          "expectedDate": "2028-02-23",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": "Feedback Requested by: 00 Mon 20XX"
        },
        {
          "chapter": "Final editing & proofing",
          "days": 6,
          "notes": "Final editing & proofing of thesis dissertation",
          "progress": "0%",
          "startDate": "2028-02-23",
          "expectedDate": "2028-02-29",
          "supervisionCommittee": "",
          "supervisorSent": "",
          "feedbackRequested": ""
        }
      ]
    },
    {
      "activityName": "# THESIS SUBMISSION",
      "elements": [
        {
          "chapter": "Supervision",
          "days": 1,
          "notes": "Supervision meeting: Zoom",
          "progress": "",
          "startDate": "2028-03-01",
          "expectedDate": "2028-03-02",
          "supervisionCommittee": "Supervision: Day 00 Mon 20XX",
          "supervisorSent": "",
          "feedbackRequested": ""
        },
        {
          "chapter": "Submit thesis",
          "days": 1,
          "notes": "Submit thesis",
          "progress": "0%",
          "startDate": "2028-03-02",
          "expectedDate": "2028-03-03",
          "supervisionCommittee": "THESIS SUBMISSION: 00 Mon 20XX",
          "supervisorSent": "Thesis submitted: DAY 00 Mon 20XX",
          "feedbackRequested": ""
        }
      ]

        }
        ];

        // ================================
        // UTILITY FUNCTIONS
        // ================================

        function calculateWeeks(days) {
            if (!days || isNaN(days)) return "0.0";
            return Math.max(0, days / 7).toFixed(1);
        }

        function addDays(date, days) {
            if (!date || date === "-" || !days) return date;
            const result = new Date(date);
            result.setDate(result.getDate() + parseInt(days));
            return result.toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === "-") return dateStr;
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ================================
        // DATA MANIPULATION FUNCTIONS
        // ================================

        function recalculateDates() {
            let lastEndDate = null;

            researchData.forEach((activity, activityIndex) => {
                activity.elements.forEach((element, elementIndex) => {
                    // Calculate start date
                    if (activityIndex === 0 && elementIndex === 0) {
                        // First element of first activity starts at the Research Start Date
                        element.startDate = researchStartDate;
                    } else if (elementIndex === 0 && lastEndDate) {
                        // First element of activity starts after previous activity's last element
                        const nextDay = new Date(lastEndDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        element.startDate = nextDay.toISOString().split('T')[0];
                    } else if (elementIndex > 0) {
                        // Subsequent elements start after previous element in same activity
                        const prevElement = activity.elements[elementIndex - 1];
                        if (prevElement.expectedDate && prevElement.expectedDate !== "-") {
                            // Set the start date without adding an extra day
                            element.startDate = prevElement.expectedDate;
                        }
                    }

                    // Calculate expected completion date
                    if (element.startDate && element.startDate !== "-" && element.days) {
                        // Calculate expected date based on the number of days specified
                        element.expectedDate = addDays(element.startDate, element.days);
                    }

                    // Update lastEndDate if this element has an end date
                    if (element.expectedDate && element.expectedDate !== "-") {
                        lastEndDate = element.expectedDate;
                    }
                });
            });
        }

        function addNewActivity() {
            const newActivity = {
                activityName: "New Activity",
                elements: [createDefaultElement()]
            };
            
            researchData.push(newActivity);
            recalculateDates();
            renderTable();
            addConsoleMessage('New activity added', 'info');
        }
        
        function addElementToActivity(activityIndex) {
            if (activityIndex < 0 || activityIndex >= researchData.length) return;
            
            researchData[activityIndex].elements.push(createDefaultElement());
            recalculateDates();
            renderTable();
            addConsoleMessage(`Element added to activity ${activityIndex}`, 'info');
        }
        
        function deleteActivity(activityIndex) {
            debugLog('deleteActivity called with index:', activityIndex);
            debugLog('researchData length before:', researchData.length);
            
            if (activityIndex < 0 || activityIndex >= researchData.length) {
                debugLog('Invalid activity index!');
                addConsoleMessage('Invalid activity index: ' + activityIndex, 'error');
                showCustomAlert('Error', '❌ Invalid activity index', 'error');
                return;
            }
            
            const activity = researchData[activityIndex];
            debugLog('Activity to delete:', activity.activityName);
            addConsoleMessage('Preparing to delete activity: ' + activity.activityName, 'warn');
            
            // Show custom confirmation dialog
            showCustomConfirm(
                'Delete Activity',
                `Do you really want to delete the activity "${activity.activityName}"?`,
                () => {
                    debugLog('User confirmed activity deletion');
                    debugLog('Proceeding with deletion...');
                    addConsoleMessage('User confirmed deletion of: ' + activity.activityName, 'info');
                    
                    researchData.splice(activityIndex, 1);
                    debugLog('researchData length after:', researchData.length);
                    
                    recalculateDates();
                    renderTable();
                    debugLog('Activity deletion completed');
                    addConsoleMessage('Activity deleted successfully: ' + activity.activityName, 'info');
                    showCustomAlert('Success', '✅ Activity deleted successfully');
                },
                () => {
                    debugLog('User cancelled activity deletion');
                    addConsoleMessage('User cancelled deletion of: ' + activity.activityName, 'info');
                }
            );
        }
        
        function deleteElement(activityIndex, elementIndex) {
            console.log('deleteElement called with:', activityIndex, elementIndex);
            console.log('researchData length:', researchData.length);
            
            if (activityIndex < 0 || activityIndex >= researchData.length) {
                console.log('Invalid activity index!');
                showCustomAlert('Error', '❌ Invalid activity index', 'error');
                return;
            }
            
            const activity = researchData[activityIndex];
            console.log('Activity:', activity.activityName, 'Elements count:', activity.elements.length);
            
            if (elementIndex < 0 || elementIndex >= activity.elements.length) {
                console.log('Invalid element index!');
                showCustomAlert('Error', '❌ Invalid element index', 'error');
                return;
            }
            
            // Show custom confirmation dialog
            showCustomConfirm(
                'Delete Element',
                `Do you really want to delete this element from "${activity.activityName}"?`,
                () => {
                    console.log('User confirmed element deletion');
                    console.log('Proceeding with deletion...');
                    if (activity.elements.length === 1) {
                        // Delete entire activity
                        console.log('Deleting entire activity (last element)...');
                        researchData.splice(activityIndex, 1);
                        console.log('Activity deleted. New length:', researchData.length);
                    } else {
                        // Delete just this element
                        console.log('Deleting element...');
                        activity.elements.splice(elementIndex, 1);
                        console.log('Element deleted. New element count:', activity.elements.length);
                    }
                    
                    recalculateDates();
                    renderTable();
                    console.log('Element deletion completed');
                    addConsoleMessage('Element deleted successfully', 'info');
                    showCustomAlert('Success', '✅ Element deleted successfully');
                },
                () => {
                    console.log('User cancelled element deletion');
                }
            );
        }
        
        function deleteAll() {
            console.log('deleteAll function started');
            
            const warningMessage = "Warning: you will lose all your data unless you have saved it! Click Cancel and then click Save Data to save your Research Plan or it will be lost forever. Do you really want to Delete All?";
            
            console.log('Showing custom confirmation dialog...');
            showCustomConfirm(
                'Delete All Data',
                warningMessage,
                () => {
                    console.log('User confirmed delete all, proceeding...');
                    console.log('researchData length before:', researchData.length);
                    
                    researchData = [];
                    console.log('researchData cleared, length now:', researchData.length);
                    
                    console.log('Calling renderTable...');
                    renderTable();
                    console.log('renderTable completed');
                    
                    addConsoleMessage('All data deleted by user', 'warn');
                    showCustomAlert('Success', '✅ All data has been deleted successfully.');
                    console.log('Delete all completed successfully');
                },
                () => {
                    console.log('User cancelled delete all');
                }
            );
        }
        
        // ================================
        // SECURE UI FUNCTIONS
        // ================================
        
        function setMode(mode) {
            currentMode = mode;
            const container = document.querySelector('.container');
            const editBtn = document.getElementById('editModeBtn');
            const viewBtn = document.getElementById('viewModeBtn');
            const helpText = document.getElementById('modeHelp');
            
            if (mode === 'edit') {
                container.classList.remove('view-mode');
                editBtn.classList.add('active');
                viewBtn.classList.remove('active');
                helpText.textContent = 'Edit Mode: Drag Activities/Elements to reorder • Click cells to edit • Use + buttons to add elements • PRINTING: for best PRINT results click View Mode';
                
                // Re-enable editing
                document.querySelectorAll('.editable').forEach(el => {
                    el.contentEditable = true;
                });
            } else {
                container.classList.add('view-mode');
                viewBtn.classList.add('active');
                editBtn.classList.remove('active');
                helpText.textContent = 'View Mode: Read-only view for presentations, review and printing • PRINTING: File Menu > Print or Export as PDF > select Orientation > Landscape for best results';
                
                // Disable editing
                document.querySelectorAll('.editable').forEach(el => {
                    el.contentEditable = false;
                });
            }
            
            renderTable();
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            researchData.forEach((activity, activityIndex) => {
                const activityClass = activityIndex % 2 === 0 ? 'activity-even' : 'activity-odd';
                
                // Render activity header row
                const activityRow = document.createElement('tr');
                activityRow.className = `activity-row ${activityClass}`;
                activityRow.draggable = currentMode === 'edit';
                activityRow.dataset.activityIndex = activityIndex;
                activityRow.dataset.rowType = 'activity';
                
                // Create cells securely
                const dragCell = createSecureElement('td');
                const dragHandle = createSecureElement('span', '⋮⋮', 'drag-handle activity-drag-handle');
                dragHandle.title = 'Drag to reorder activities';
                dragCell.appendChild(dragHandle);
                
                const activityCell = createSecureElement('td', '', 'activity-cell');
    
                const activityName = createSecureElement('span', activity.activityName, 'activity-name editable');
                activityName.contentEditable = currentMode === 'edit';
                activityName.dataset.field = 'activityName';
               
                const activityPrefix = createSecureElement('span',`└─ Activity`,'activity-btns-prefix');     
                const deleteBtn = createSecureElement('button', '×', 'delete-btn');
                deleteBtn.dataset.action = 'delete-activity';
                deleteBtn.dataset.activityIndex = activityIndex;
                
                const addElementBtn = createSecureElement('button', '+ Element', 'add-element-btn');
                addElementBtn.dataset.action = 'add-element';
                addElementBtn.dataset.activityIndex = activityIndex;
                
                activityCell.appendChild(activityName);
                activityCell.appendChild(activityPrefix);   
                activityCell.appendChild(deleteBtn);   
                activityCell.appendChild(addElementBtn);

                
                const countCell = createSecureElement('td', `${activity.elements.length} element${activity.elements.length !== 1 ? 's' : ''}`, 'element-count');
                countCell.colSpan = 10;
                countCell.style.color = '#666';
                countCell.style.fontStyle = 'italic';
                
                activityRow.appendChild(dragCell);
                activityRow.appendChild(activityCell);
                activityRow.appendChild(countCell);
                
                tbody.appendChild(activityRow);
                
                // Render elements
                activity.elements.forEach((element, elementIndex) => {
                    const elementRow = document.createElement('tr');
                    elementRow.className = `element-row ${activityClass}`;
                    elementRow.draggable = currentMode === 'edit';
                    elementRow.dataset.activityIndex = activityIndex;
                    elementRow.dataset.elementIndex = elementIndex;
                    elementRow.dataset.rowType = 'element';
                    
                    // Create all cells securely
                    const cells = [
                        createDragCell(),
                        createElementNameCell(activityIndex, elementIndex),
                        createEditableCell(element.chapter, 'chapter', 'chapter-cell'),
                        createEditableCell(element.days.toString(), 'days', 'days-cell'),
                        createStaticCell(calculateWeeks(element.days), 'weeks-cell'),
                        createEditableCell(element.notes, 'notes', 'notes-cell'),
                        createEditableCell(element.progress, 'progress', 'progress-cell'),
                        createDateCell(element.startDate),
                        createDateCell(formatDate(element.expectedDate)),
                        createSupervisorCell(element.supervisionCommittee, 'supervisionCommittee', 'supervision-committee'),
                        createSupervisorCell(element.supervisorSent, 'supervisorSent', 'supervisor-sent'),
                        createSupervisorCell(element.feedbackRequested, 'feedbackRequested', 'feedback-requested')
                    ];
                    
                    cells.forEach(cell => elementRow.appendChild(cell));
                    tbody.appendChild(elementRow);
                });
            });
        }

        function createDragCell() {
            const cell = createSecureElement('td');
            const handle = createSecureElement('span', '⋮', 'drag-handle element-drag-handle');
            handle.title = 'Drag to reorder elements';
            cell.appendChild(handle);
            return cell;
        }

        function createElementNameCell(activityIndex, elementIndex) {
            const cell = createSecureElement('td', '', 'activity-cell');
            const prefix = createSecureElement('span', `└─ Element ${elementIndex + 1}`, 'element-prefix');
            const deleteBtn = createSecureElement('button', '×', 'delete-btn');
            deleteBtn.dataset.action = 'delete-element';
            deleteBtn.dataset.activityIndex = activityIndex;
            deleteBtn.dataset.elementIndex = elementIndex;
            
            cell.appendChild(prefix);
            cell.appendChild(deleteBtn);
            return cell;
        }

        function createEditableCell(content, field, className = '') {
            const cell = createSecureElement('td', '', className);
            const editableDiv = createSecureElement('div', content, 'editable');
            editableDiv.contentEditable = currentMode === 'edit';
            editableDiv.dataset.field = field;
            cell.appendChild(editableDiv);
            return cell;
        }

        function createStaticCell(content, className = '') {
            return createSecureElement('td', content, className);
        }

        function createDateCell(dateStr) {
            if (dateStr === "-" || !dateStr) {
                return createSecureElement('td', dateStr || "", 'date-cell');
            }
            
            // Check if it's already a formatted date string (contains comma or weekday)
            if (dateStr.includes(',') || /\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b/.test(dateStr)) {
                // Already formatted, use as-is
                return createSecureElement('td', dateStr, 'date-cell');
            }
            
            // Raw date string, format it normally
            const displayDate = new Date(dateStr).toLocaleDateString();
            return createSecureElement('td', displayDate, 'date-cell');
        }

        function createSupervisorCell(content, field, baseClass) {
            const hasData = content && content.trim();
            const className = `date-cell ${baseClass}-cell ${baseClass} ${hasData ? 'has-data' : ''}`;
            return createEditableCell(content, field, className);
        }
        
        // ================================
        // ENHANCED EVENT HANDLERS
        // ================================
        
        function setupEventDelegation() {
            // Research Start Date change handler
            const researchStartDateInput = document.getElementById('researchStartDate');
            if (researchStartDateInput) {
                researchStartDateInput.addEventListener('change', function(e) {
                    researchStartDate = e.target.value;
                    recalculateDates();
                    renderTable();
                    addConsoleMessage('Research start date updated: ' + researchStartDate, 'info');
                });
            }
            
            // Use document-level event delegation to catch all buttons
            document.addEventListener('click', function(e) {
                debugLog('Click detected on:', e.target.tagName, e.target.className, e.target.dataset.action);
                
                // Handle delete buttons first
                if (e.target.classList.contains('delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const action = e.target.dataset.action;
                    debugLog('Delete action:', action);
                    
                    if (action === 'delete-activity') {
                        const activityIndex = parseInt(e.target.dataset.activityIndex);
                        debugLog('Calling deleteActivity with index:', activityIndex);
                        deleteActivity(activityIndex);
                    } else if (action === 'delete-element') {
                        const activityIndex = parseInt(e.target.dataset.activityIndex);
                        const elementIndex = parseInt(e.target.dataset.elementIndex);
                        debugLog('Calling deleteElement with:', activityIndex, elementIndex);
                        deleteElement(activityIndex, elementIndex);
                    }
                    return;
                }
                
                // Handle other buttons
                const action = e.target.dataset.action;
                debugLog('Button action detected:', action);
                
                if (action === 'save-data') {
                    debugLog('Save data clicked - calling function...');
                    e.preventDefault();
                    try {
                        saveData();
                        debugLog('saveData function called successfully');
                    } catch (error) {
                        console.error('Error calling saveData:', error);
                    }
                } else if (action === 'load-data') {
                    debugLog('Load data clicked - calling function...');
                    e.preventDefault();
                    try {
                        loadData();
                        debugLog('loadData function called successfully');
                    } catch (error) {
                        console.error('Error calling loadData:', error);
                    }
                } else if (action === 'delete-all') {
                    debugLog('Delete all clicked - calling function...');
                    e.preventDefault();
                    try {
                        deleteAll();
                        debugLog('deleteAll function called successfully');
                    } catch (error) {
                        console.error('Error calling deleteAll:', error);
                    }
                } else if (action === 'add-element') {
                    debugLog('Add element clicked - calling function...');
                    e.preventDefault();
                    try {
                        const activityIndex = parseInt(e.target.dataset.activityIndex);
                        addElementToActivity(activityIndex);
                        debugLog('addElementToActivity function called successfully');
                    } catch (error) {
                        console.error('Error calling addElementToActivity:', error);
                    }
                }
            });
            
            // Console button handler
            const consoleBtn = document.getElementById('consoleBtn');
            if (consoleBtn) {
                consoleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleDebugMode();
                });
            }
            
            // Console clear button handler
            const consoleClearBtn = document.getElementById('consoleClearBtn');
            if (consoleClearBtn) {
                consoleClearBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    clearConsole();
                    debugLog('Console cleared by user');
                });
            }
            
            // Floating add button handler
            const addActivityBtn = document.querySelector('.add-activity-btn');
            if (addActivityBtn) {
                addActivityBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    addNewActivity();
                });
            }
            
            // Mode button handlers
            document.getElementById('editModeBtn').addEventListener('click', () => setMode('edit'));
            document.getElementById('viewModeBtn').addEventListener('click', () => setMode('view'));
            
            // Drag and drop handlers
            const tbody = document.getElementById('tableBody');
            tbody.addEventListener('dragstart', handleDragStart, false);
            tbody.addEventListener('dragover', handleDragOver, false);
            tbody.addEventListener('drop', handleDrop, false);
            tbody.addEventListener('dragend', handleDragEnd, false);
            tbody.addEventListener('dragenter', handleDragEnter, false);
            
            // Handle drag initiation from drag handles specifically
            tbody.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('drag-handle') || 
                    e.target.classList.contains('activity-drag-handle') || 
                    e.target.classList.contains('element-drag-handle')) {
                    
                    // Make sure the parent row is draggable
                    const row = e.target.closest('tr');
                    if (row && currentMode === 'edit') {
                        row.draggable = true;
                    }
                }
            });
            
            // Enhanced edit handlers with security
            tbody.addEventListener('blur', function(e) {
                if (e.target.classList.contains('editable')) {
                    const field = e.target.dataset.field;
                    if (field === 'activityName') {
                        handleActivityNameEdit(e);
                    } else {
                        handleCellEdit(e);
                    }
                }
            }, true);
            
            tbody.addEventListener('keydown', function(e) {
                if (e.target.classList.contains('editable') && e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.target.blur();
                }
            });

            // Enhanced real-time input protection with visual feedback
            tbody.addEventListener('input', function(e) {
                if (e.target.classList.contains('editable')) {
                    const content = e.target.textContent;
                    const originalContent = content;
                    
                    // Apply real-time sanitization
                    const sanitized = secureSanitizeInput(content, e.target, 'realtime_input');
                    
                    if (content !== sanitized) {
                        e.target.textContent = sanitized;
                        
                        // Restore cursor position at end
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(e.target);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        
                        addConsoleMessage('Real-time protection: Dangerous content blocked', 'security');
                    }
                }
            });

            // Enhanced Research Title field protection
            const researchTitleField = document.querySelector('.research-title .wrap');
            if (researchTitleField) {
                researchTitleField.addEventListener('input', function(e) {
                    const content = e.target.textContent;
                    const sanitized = secureSanitizeInput(content, e.target, 'research_title');
                    
                    if (content !== sanitized) {
                        e.target.textContent = sanitized;
                        
                        // Restore cursor position
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(e.target);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        
                        addConsoleMessage('Research title protected from malicious content', 'security');
                    }
                });
            }
        }
        
        function handleActivityNameEdit(e) {
            const activityIndex = parseInt(e.target.closest('tr').dataset.activityIndex);
            const newName = secureSanitizeInput(e.target.textContent.trim(), e.target, 'activity_name');
            
            if (activityIndex >= 0 && newName.length <= 200) {
                researchData[activityIndex].activityName = newName;
                e.target.textContent = newName; // Ensure sanitized content is displayed
            }
        }
        
        function handleCellEdit(e) {
            const field = e.target.dataset.field;
            const elementRow = e.target.closest('tr');
            const activityIndex = parseInt(elementRow.dataset.activityIndex);
            const elementIndex = parseInt(elementRow.dataset.elementIndex);
            const rawValue = e.target.textContent.trim();
            
            if (field && activityIndex >= 0 && elementIndex >= 0) {
                // Apply field-specific validation with security
                switch (field) {
                    case 'days':
                        const days = Math.max(0, Math.min(parseInt(rawValue) || 0, 3650));
                        researchData[activityIndex].elements[elementIndex][field] = days;
                        e.target.textContent = days.toString();
                        recalculateDates();
                        renderTable();
                        break;
                    case 'startDate':
                    case 'expectedDate':
                        const dateValue = validateDateString(rawValue) ? rawValue : '';
                        researchData[activityIndex].elements[elementIndex][field] = dateValue;
                        if (dateValue !== rawValue) {
                            e.target.textContent = dateValue;
                        }
                        break;
                    default:
                        const maxLength = field === 'progress' ? 50 : 
                                        field === 'chapter' ? 200 : 
                                        SECURITY_CONFIG.MAX_STRING_LENGTH;
                        const sanitizedValue = secureSanitizeInput(rawValue, e.target, 'cell_edit').substring(0, maxLength);
                        researchData[activityIndex].elements[elementIndex][field] = sanitizedValue;
                        if (sanitizedValue !== rawValue) {
                            e.target.textContent = sanitizedValue;
                        }
                        break;
                }
                
                // Update supervisor column coloring for relevant fields
                if (['supervisorSent', 'feedbackRequested', 'supervisionCommittee'].includes(field)) {
                    renderTable();
                }
            }
        }
        
        // ================================
        // DRAG AND DROP FUNCTIONS
        // ================================
        
        function handleDragStart(e) {
            if (currentMode !== 'edit') {
                e.preventDefault();
                return;
            }
            
            const row = e.target.closest('tr');
            if (!row) {
                e.preventDefault();
                return;
            }
            
            const isDragHandle = e.target.classList.contains('drag-handle') || 
                               e.target.classList.contains('activity-drag-handle') || 
                               e.target.classList.contains('element-drag-handle');
            
            if (!isDragHandle && !row.draggable) {
                e.preventDefault();
                return;
            }
            
            draggedElement = row;
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '');
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            
            const targetRow = e.target.tagName === 'TR' ? e.target : e.target.closest('tr');
            if (targetRow && targetRow !== draggedElement && draggedElement) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                const draggedType = draggedElement.dataset.rowType;
                const targetType = targetRow.dataset.rowType;
                
                if ((draggedType === 'activity' && targetType === 'activity') ||
                    (draggedType === 'element' && targetType === 'element')) {
                    targetRow.classList.add('drag-over');
                }
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetRow = e.target.tagName === 'TR' ? e.target : e.target.closest('tr');
            
            if (!targetRow || !draggedElement || targetRow === draggedElement) {
                return;
            }
            
            const draggedType = draggedElement.dataset.rowType;
            const targetType = targetRow.dataset.rowType;
            
            if (draggedType === 'activity' && targetType === 'activity') {
                const draggedIndex = parseInt(draggedElement.dataset.activityIndex);
                const targetIndex = parseInt(targetRow.dataset.activityIndex);
                
                if (draggedIndex !== targetIndex && !isNaN(draggedIndex) && !isNaN(targetIndex)) {
                    const draggedActivity = researchData.splice(draggedIndex, 1)[0];
                    researchData.splice(targetIndex, 0, draggedActivity);
                    
                    recalculateDates();
                    renderTable();
                    addConsoleMessage(`Activity reordered: ${draggedIndex} → ${targetIndex}`, 'info');
                }
            } else if (draggedType === 'element' && targetType === 'element') {
                const draggedActivityIndex = parseInt(draggedElement.dataset.activityIndex);
                const draggedElementIndex = parseInt(draggedElement.dataset.elementIndex);
                const targetActivityIndex = parseInt(targetRow.dataset.activityIndex);
                const targetElementIndex = parseInt(targetRow.dataset.elementIndex);
                
                if (draggedActivityIndex === targetActivityIndex) {
                    if (draggedElementIndex !== targetElementIndex) {
                        const draggedElementData = researchData[draggedActivityIndex].elements.splice(draggedElementIndex, 1)[0];
                        researchData[draggedActivityIndex].elements.splice(targetElementIndex, 0, draggedElementData);
                        
                        recalculateDates();
                        renderTable();
                        addConsoleMessage(`Element reordered within activity ${draggedActivityIndex}`, 'info');
                    }
                } else {
                    const draggedElementData = researchData[draggedActivityIndex].elements.splice(draggedElementIndex, 1)[0];
                    researchData[targetActivityIndex].elements.splice(targetElementIndex, 0, draggedElementData);
                    
                    recalculateDates();
                    renderTable();
                    addConsoleMessage(`Element moved between activities: ${draggedActivityIndex} → ${targetActivityIndex}`, 'info');
                }
            }
        }
        
        function handleDragEnd(e) {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedElement = null;
        }
        
        // ================================
        // ENHANCED SECURE SAVE AND LOAD FUNCTIONS
        // ================================
        
        function saveData() {
            debugLog('saveData function started');
            addConsoleMessage('Starting secure data save operation...', 'info');
            
            try {
                debugLog('Creating save object...');
                const saveObject = {
                    version: "1.4.0",
                    appName: "Research Planner - Enterprise Security Edition",
                    exportDate: new Date().toISOString(),
                    researchStartDate: researchStartDate,
                    totalActivities: researchData.length,
                    totalElements: researchData.reduce((sum, activity) => sum + activity.elements.length, 0),
                    data: researchData,
                    securityInfo: {
                        cspEnabled: true,
                        sanitizationVersion: "enhanced",
                        exportedBy: "enterprise-security-edition"
                    }
                };
                
                debugLog('Save object created:', saveObject);
                addConsoleMessage(`Save object created: ${saveObject.totalActivities} activities, ${saveObject.totalElements} elements`, 'info');
                addConsoleMessage('Security metadata included in export', 'security');
                
                // Apply sanitization to save data (defensive measure)
                const sanitizedSaveObject = JSON.parse(JSON.stringify(saveObject, (key, value) => {
                    if (typeof value === 'string') {
                        return secureSanitizeInput(value, null, 'export_data');
                    }
                    return value;
                }));
                
                debugLog('Converting to JSON...');
                const dataStr = JSON.stringify(sanitizedSaveObject, null, 2);
                debugLog('JSON created, length:', dataStr.length);
                addConsoleMessage(`Secure JSON data prepared (${dataStr.length} characters)`, 'info');
                
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `research-planner-secure-${timestamp}.json`;
                debugLog('Filename:', filename);
                
                debugLog('Attempting clipboard copy...');
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(dataStr).then(() => {
                        debugLog('Clipboard copy successful');
                        addConsoleMessage('Data copied to clipboard successfully!', 'info');
                        addConsoleMessage('Export completed with enterprise security', 'security');
                        showSaveSuccessModal(filename, saveObject.totalActivities, saveObject.totalElements);
                    }).catch((error) => {
                        debugLog('Clipboard failed, showing prompt:', error);
                        addConsoleMessage('Clipboard copy failed, showing manual save dialog', 'warn');
                        showDataInPrompt(dataStr, filename);
                    });
                } else {
                    debugLog('Clipboard not available, showing prompt');
                    addConsoleMessage('Clipboard API not available, showing manual save dialog', 'warn');
                    showDataInPrompt(dataStr, filename);
                }
                
            } catch (error) {
                console.error('Save error:', error);
                addConsoleMessage('Save error: ' + error.message, 'error');
                showCustomAlert('Save Error', '❌ Error preparing save data: ' + error.message, 'error');
            }
        }
        
        function showDataInPrompt(dataStr, filename) {
            console.log('showDataInPrompt called with filename:', filename);
            console.log('Data string length:', dataStr.length);
            
            if (dataStr.length > 2000) {
                console.log('Data is large, showing in parts');
                showCustomAlert('Manual Save Required', '💾 Your data has been securely processed with enterprise protection.\n📄 Data is large - showing in copyable format.');
                
                // Show first chunk
                const chunk1 = dataStr.substring(0, 2000);
                const remainingLength = dataStr.length - 2000;
                
                console.log('Showing first chunk, length:', chunk1.length);
                showCustomPrompt(
                    'Copy Secure Data - Part 1',
                    `📋 Copy this text and save as ${filename}\n🛡️ Data secured with enterprise protection\n(${remainingLength} more characters in part 2)`,
                    chunk1
                );
                
                // Option to show second part
                setTimeout(() => {
                    showCustomConfirm(
                        'Show Remaining Data',
                        'Show part 2 of the secure data?',
                        () => {
                            console.log('Showing remaining data');
                            showCustomPrompt(
                                'Copy Secure Data - Part 2',
                                '📋 Copy and append this text to part 1:',
                                dataStr.substring(2000)
                            );
                        },
                        () => {
                            console.log('User chose not to see part 2');
                        }
                    );
                }, 1000);
            } else {
                console.log('Data fits in single prompt');
                showCustomAlert('Manual Save Required', '💾 Your data has been securely processed with enterprise protection.\nClick OK to see the copyable data.');
                setTimeout(() => {
                    showCustomPrompt(
                        'Copy Secure Data',
                        `📋 Copy this data and save as ${filename}:\n🛡️ Enhanced security applied`,
                        dataStr
                    );
                }, 500);
            }
            console.log('showDataInPrompt completed');
        }
        
        function loadData() {
            debugLog('loadData function called');
            addConsoleMessage('Starting secure data load operation...', 'info');
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,application/json,text/plain';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                
                if (!file) return;
                
                try {
                    addConsoleMessage(`File selected: ${file.name} (${file.size} bytes)`, 'info');
                    
                    // Enhanced security validations
                    validateFileSize(file);
                    validateFileType(file);
                    
                    const reader = new FileReader();
                    
                    // Set timeout for file reading
                    const timeoutId = setTimeout(() => {
                        reader.abort();
                        showCustomAlert('Timeout Error', '❌ File reading timeout. File may be too large or complex.', 'error');
                        addConsoleMessage('File read timeout - security protection activated', 'security');
                    }, SECURITY_CONFIG.PARSING_TIMEOUT);
                    
                    reader.onload = function(e) {
                        clearTimeout(timeoutId);
                        
                        try {
                            const jsonText = e.target.result;
                            addConsoleMessage('File read successfully, starting security scan...', 'info');
                            
                            // Enhanced security scanning
                            if (SECURITY_CONFIG.SECURITY_SCAN_ENABLED) {
                                securityScanFileContent(jsonText, file.name);
                            }
                            
                            // Parse with timeout protection
                            const parseTimeoutId = setTimeout(() => {
                                throw new Error('JSON parsing timeout - file may be malformed or malicious');
                            }, SECURITY_CONFIG.PARSING_TIMEOUT);
                            
                            const loadedData = JSON.parse(jsonText);
                            clearTimeout(parseTimeoutId);
                            
                            debugLog('JSON parsed successfully');
                            addConsoleMessage('JSON parsing completed successfully', 'info');
                            
                            // Enhanced validation
                            debugLog('Starting enhanced JSON structure validation...');
                            validateJsonStructure(loadedData);
                            addConsoleMessage('✅ Data structure validation passed', 'security');
                            
                            // Sanitize the loaded data with enterprise protection
                            const sanitizedData = sanitizeLoadedData(loadedData);
                            addConsoleMessage('Data sanitization completed', 'security');
                            
                            // Handle different data formats
                            if (sanitizedData.data && Array.isArray(sanitizedData.data)) {
                                // New format with metadata
                                researchData = sanitizedData.data;
                                
                                // Restore research start date if available
                                if (sanitizedData.researchStartDate) {
                                    researchStartDate = sanitizedData.researchStartDate;
                                    const dateInput = document.getElementById('researchStartDate');
                                    if (dateInput) {
                                        dateInput.value = researchStartDate;
                                    }
                                }
                                
                                let securityInfo = '';
                                if (sanitizedData.securityInfo) {
                                    securityInfo = '\n🛡️ Security: ' + (sanitizedData.securityInfo.cspEnabled ? 'CSP Protected' : 'Standard') + 
                                                 ' • ' + (sanitizedData.securityInfo.sanitizationVersion || 'basic') + ' sanitization';
                                }
                                
                                showCustomAlert('Secure Data Loaded', `✅ Data loaded successfully with enterprise protection!\n🛡️ Security: All data has been scanned and sanitized\n📊 ${sanitizedData.totalActivities || researchData.length} activities\n📅 Exported: ${sanitizedData.exportDate ? new Date(sanitizedData.exportDate).toLocaleString() : 'Unknown date'}${securityInfo}`);
                                
                            } else if (Array.isArray(sanitizedData)) {
                                // Old format (direct array)
                                researchData = sanitizedData;
                                showCustomAlert('Secure Data Loaded', `✅ Data loaded successfully with enterprise protection!\n🛡️ Security: All data has been scanned and sanitized\n📊 ${researchData.length} activities loaded\n⚠️ Legacy format detected - consider re-saving for enhanced security`);
                            }
                            
                            // Update the interface
                            recalculateDates();
                            renderTable();
                            addConsoleMessage('Data load completed successfully', 'info');
                            addConsoleMessage('Enterprise security scan completed - no threats detected', 'security');
                            
                        } catch (error) {
                            console.error('Error loading data:', error);
                            addConsoleMessage('Load error: ' + error.message, 'error');
                            
                            let errorMsg = '❌ Error loading file:\n\n' + error.message;
                            
                            if (error instanceof SyntaxError) {
                                errorMsg += '\n\n💡 Make sure the file contains valid JSON data from the Research Planner.';
                            } else if (error.message.includes('Security scan failed')) {
                                errorMsg += '\n\n🛡️ Enterprise security protection prevented loading of potentially dangerous content.';
                            }
                            
                            showCustomAlert('Secure Load Error', errorMsg, 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        clearTimeout(timeoutId);
                        console.error('FileReader error occurred');
                        addConsoleMessage('File reader error - security protection activated', 'security');
                        showCustomAlert('File Error', '❌ Error reading the selected file. Please try again.', 'error');
                    };
                    
                    // Start reading the file
                    reader.readAsText(file);
                    
                } catch (error) {
                    addConsoleMessage('File validation error: ' + error.message, 'error');
                    showCustomAlert('File Validation Error', '❌ File validation error: ' + error.message, 'error');
                }
                
                // Clean up
                if (fileInput.parentNode) {
                    fileInput.parentNode.removeChild(fileInput);
                }
            };
            
            // Add to DOM and click
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        // ================================
        // ENHANCED INITIALIZATION
        // ================================
        
        // Check for security libraries on startup
        function checkSecurityLibraries() {
            const status = {
                DOMPurify: !!window.DOMPurify,
                AJV: !!window.Ajv,
                CSP: !!document.querySelector('meta[http-equiv="Content-Security-Policy"]'),
                enhancedProtection: true
            };
            
            addConsoleMessage('🛡️ Security Status Check:', 'security');
            addConsoleMessage(`  - DOMPurify: ${status.DOMPurify ? '✅ Enhanced' : '❌ Missing'}`, 'security');
            addConsoleMessage(`  - Schema Validation: ${status.AJV ? '✅ Active' : '❌ Missing'}`, 'security');
            addConsoleMessage(`  - Content Security Policy: ${status.CSP ? '✅ Enabled' : '❌ Missing'}`, 'security');
            addConsoleMessage(`  - Real-time Protection: ${status.enhancedProtection ? '✅ Active' : '❌ Disabled'}`, 'security');
            
            if (status.DOMPurify && status.AJV && status.CSP) {
                console.log('🛡️ ENTERPRISE SECURITY: All security systems operational');
                addConsoleMessage('Enterprise security suite fully operational', 'security');
            } else {
                console.warn('⚠️ Some security features missing:', status);
                if (!status.DOMPurify) {
                    console.error('DOMPurify missing - XSS protection compromised');
                    addConsoleMessage('Critical: DOMPurify missing', 'error');
                }
                if (!status.AJV) {
                    console.error('AJV missing - Schema validation compromised');
                    addConsoleMessage('Warning: Schema validation missing', 'warn');
                }
                if (!status.CSP) {
                    console.error('CSP missing - Script injection protection compromised');
                    addConsoleMessage('Critical: Content Security Policy missing', 'error');
                }
            }
            
            return status;
        }

        // Check if all functions are properly defined
        function checkFunctionAvailability() {
            debugLog('🔍 Checking function availability...');
            const functions = ['saveData', 'loadData', 'deleteAll', 'addElementToActivity', 'deleteElement', 'deleteActivity', 'secureSanitizeInput', 'securityScanFileContent'];
            functions.forEach(funcName => {
                const available = typeof window[funcName] === 'function' || typeof eval(funcName) === 'function';
                debugLog(`${funcName}:`, available ? '✅ Available' : '❌ Missing');
            });
        }
        
        // Initialize the application with enhanced security
        function initializeApp() {
            debugLog('🚀 Initializing Research Planner Enterprise Security Edition...');
            addConsoleMessage('Starting enterprise security initialization...', 'info');
            
            const securityStatus = checkSecurityLibraries();
            checkFunctionAvailability();
            
            // Initialize security event log
            window.securityEventLog = window.securityEventLog || [];
            
            // Set security indicator status
            const indicator = document.getElementById('securityIndicator');
            if (indicator && securityStatus.CSP && securityStatus.DOMPurify) {
                indicator.style.background = '#5CC937';
                indicator.innerHTML = '🛡️ App Status: Secure 🛡️';
            } else {
                indicator.style.background = '#ffc107';
                indicator.innerHTML = '⚠️ PARTIAL SECURITY ⚠️';
            }
            
            recalculateDates();
            renderTable();
            setMode('edit');
            setupEventDelegation();
            
            addConsoleMessage('✅ Research Planner Enterprise Security v1.4.0 initialized', 'info');
            addConsoleMessage('🛡️ Enterprise-grade protection active', 'security');
            debugLog('🛡️ Research Planner Enterprise Security v1.4.0 initialized with enhanced protection');
        }
        
        // Initialize immediately if DOM already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
